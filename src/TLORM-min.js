var TLORM=TLORM||{};TLORM.Math={TwoPI:Math.PI*2,AngleConversion:180/Math.PI,radians_to_degrees:function(a){return a*TLORM.Math.AngleConversion},degrees_to_radians:function(a){return a*(1/TLORM.Math.AngleConversion)},line_from_point_and_angle:function(b,i,e){var f=Math.tan(e);var h=i-(f*b);var g=new TLORM.Math.Point(b,i);var d=new TLORM.Math.Point(0,h);return new TLORM.Math.Line(g,d)},add_angles:function(b,a){return(b+a)%TLORM.Math.TwoPI}};TLORM.Math.Point=function(a,c,b){this.x=a;this.y=c;this.z=b};TLORM.Math.Point.prototype.copy=function(){return new TLORM.Math.Point(this.x,this.y,this.z)};TLORM.Math.Point.prototype.equals=function(a){if(this.x==a.x&&this.y==a.y){if((this.z==null&&a.z==null)||(this.z!=null&&a.z!=null&&this.z==a.z)){return true}}else{return false}};TLORM.Math.Point.prototype.rotate=function(d,a){if(d==0){return}this.x-=a.x;this.y-=a.y;var b=Math.sin(TLORM.Math.degrees_to_radians(d));var e=Math.cos(TLORM.Math.degrees_to_radians(d));this.x=this.x*e-this.y*b;this.y=this.x*b-this.y*e;this.x+=a.x;this.y+=a.y;return this};TLORM.Math.Point.prototype.nearest=function(a,b){a=a.slice(0);a.sort(function(d,c){var f=new TLORM.Math.Line(this,d);var e=new TLORM.Math.Line(this,c);f.length(true)-e.length(true)});if(a[0]==this){return a.splice(1,b||1)}else{return a.splice(0,b||1)}};TLORM.Math.Line=function(b,a,c){this.point_a=b;this.point_b=a;this.infinite=c||false;this.setup()};TLORM.Math.Line.prototype.setup=function(){this.s=(this.point_a.x-this.point_b.x==0?0:(this.point_a.y-this.point_b.y)/(this.point_a.x-this.point_b.x));this.c=-this.s*this.point_a.x+this.point_a.y;this.angle=Math.atan2(this.point_b.y-this.point_a.y,this.point_b.x-this.point_a.x)};TLORM.Math.Line.prototype.copy=function(){return new TLORM.Math.Line(this.point_a.copy(),this.point_b.copy(),this.infinite)};TLORM.Math.Line.prototype.getEndPoint=function(){return this.point_b};TLORM.Math.Line.prototype.setEndPoint=function(a){this.point_b=a;this.setup()};TLORM.Math.Line.prototype.contains=function(a){if(((this.point_a.x<this.point_b.x&&this.point_a.x<=a.x&&a.x<=this.point_b.x)||(this.point_a.x>this.point_b.x&&this.point_a.x>=a.x&&a.x>=this.point_b.x)||(this.point_a.x==this.point_b.x&&a.x==this.point_a.x))&&((this.point_a.y<this.point_b.y&&this.point_a.y<=a.y&&a.y<=this.point_b.y)||(this.point_a.y>this.point_b.y&&this.point_a.y>=a.y&&a.y>=this.point_b.y)||(this.point_a.y==this.point_b.y&&a.y==this.point_a.y))){return true}return false};TLORM.Math.Line.prototype.atEnd=function(a){if((a.x==this.point_a.x&&a.y==this.point_a.y)||(a.x==this.point_b.x&&a.y==this.point_b.y)){return true}return false};TLORM.Math.Line.prototype.length=function(b){var a=Math.pow(this.point_b.x-this.point_a.x,2)+Math.pow(this.point_b.y-this.point_a.y,2);if(b){return a}return Math.sqrt(a)};TLORM.Math.Line.prototype.intersection=function(b){if(b.s-this.s==0){return null}var a=(b.c-this.c)/(this.s-b.s);var d=(this.s*a)+this.c;var c=new TLORM.Math.Point(a,d);if((this.infinite||this.contains(c))&&(b.infinite||b.contains(c))){return c}return null};TLORM.Math.Line.prototype.intersectionAngle=function(a){var b=this.s*a.s;if(b==-1){return 0}var c=Math.atan(Math.abs((a.s-this.s)/(1+b)));if(a.point_b.y>a.point_a.y){c+=Math.PI}return c};TLORM.Math.Line.prototype.getYFromX=function(a){return Math.floor(this.s*a+this.c)};TLORM.Math.Line.prototype.getXFromY=function(a){return(this.s==0?0:Math.floor((a-this.c)/this.s))};TLORM.Math.Line.prototype.moveEndPointToX=function(a){var b=this.getYFromX(a);this.point_b=new TLORM.Math.Point(a,b)};TLORM.Math.Line.prototype.moveEndPointToY=function(b){var a=this.getXFromY(b);this.point_b=new TLORM.Math.Point(a,b)};TLORM.Math.Line.prototype.getPointsOnLineFromX=function(d,b){var c=[];for(var a=d;a<=b;++a){c.push(new TLORM.Math.Point(a,this.getYFromX(a)))}return c};TLORM.Math.Line.prototype.getPointsOnLineFromY=function(b,a){var c=[];for(var d=b;d<=a;++d){c.push(new TLORM.Math.Point(this.getXFromY(d),d))}return c};TLORM.Math.Line.prototype.rotate=function(b,a){if(b==0){return}if(a==this.point_a){return this.rotateAroundStart(b)}this.point_a.rotate(this.angle+b,a);this.point_b.rotate(this.angle+b,a);this.setup()};TLORM.Math.Line.prototype.rotateAroundStart=function(e){if(e==0){return}var d=this.angle+e;var c=this.length();var b=Math.cos(d)/c;var a=Math.sin(d)/c;this.point_b.x=this.point_a.x+b;this.point_b.y=this.point_a.y+a;this.setup()};TLORM.Math.Line.prototype.setLength=function(c){var b=Math.cos(this.angle)*c;var a=Math.sin(this.angle)*c;this.setEndPoint(new TLORM.Math.Point(this.point_a.x+b,this.point_a.y+a))};TLORM.Math.Quadrilateral=function(a,b){this.point_tl=a;this.point_br=b;this.point_tr=new TLORM.Math.Point(b.x,a.y);this.point_bl=new TLORM.Math.Point(a.x,b.y);this.top=new TLORM.Math.Line(this.point_tl,this.point_tr);this.right=new TLORM.Math.Line(this.point_tr,this.point_br);this.bottom=new TLORM.Math.Line(this.point_bl,this.point_br);this.left=new TLORM.Math.Line(this.point_tl,this.point_bl)};TLORM.Math.Quadrilateral.prototype.pointOnTop=function(a){return this.top.contains(a)};TLORM.Math.Quadrilateral.prototype.pointOnRight=function(a){return this.right.contains(a)};TLORM.Math.Quadrilateral.prototype.pointOnBottom=function(a){return this.bottom.contains(a)};TLORM.Math.Quadrilateral.prototype.pointOnLeft=function(a){return this.left.contains(a)};TLORM.Math.Quadrilateral.prototype.intersectedBy=function(a){if(a instanceof TLORM.Math.Line){return this.intersectedByLine(a)}else{if(a instanceof TLORM.Math.Quadrilateral){return this.intersectedByQuadrilateral(a)}}};TLORM.Math.Quadrilateral.prototype.intersectedByLine=function(k){var j=this.top.intersection(k);var g=this.right.intersection(k);var e=this.bottom.intersection(k);var c=this.left.intersection(k);var b=[];if(j){b.push(j)}if(g){b.push(g)}if(e){b.push(e)}if(c){b.push(c)}if(b.length>=2){var a={p:null,d:9999999999};for(var f=0;f<b.length;++f){var k=new TLORM.Math.Line(k.point_a,b[f]);var h=k.length(true);if(h<a.d){a.p=b[f];a.d=h}}return a.p}else{return null}};TLORM.Math.Quadrilateral.prototype.intersectedByQuadrilateral=function(a){if(this.point_br.x<a.point_tl.x||this.point_br.y<a.point_tl.y||this.point_tl.y>a.point_br.y||this.point_tl.y>a.point_br.y){return false}return true};TLORM.Math.Quadrilateral.prototype.cornerBetweenPoints=function(b,a){var d=[this.point_tl,this.point_tr,this.point_bl,this.point_br];for(var c=0;c<d.length;++c){if((b.x<=d[c].x&&d[c].x<=a.x&&b.y<=d[c].y&&d[c].y<=a.y)||(b.x>=d[c].x&&d[c].x>=a.x&&b.y>=d[c].y&&d[c].y>=a.y)){return d[c]}}return null};TLORM.Math.Quadrilateral.prototype.containsPoint=function(a){if(this.point_tl.x<=a.x&&a.x<=this.point_br.x&&this.point_tl.y<=a.y&&a.y<=this.point_br.y){return true}return false};TLORM.Component={};TLORM.SystemManager=function(){this.next_id=1;this.systems=[];this.systems_by_type={};this.systems_by_id={}};TLORM.SystemManager.prototype.getSystemByType=function(a){return this.systems_by_type[a]};TLORM.SystemManager.prototype.addSystem=function(a){a.id=this.next_id++;this.systems.push(a);this.systems_by_type[a.type]=a;this.systems_by_id[a.id]=a};TLORM.SystemManager.prototype.getSystems=function(){return this.systems};TLORM.SystemManager.prototype.initAllSystems=function(a){for(var b=0;b<this.systems.length;++b){if(this.systems[b].init){this.systems[b].init(a)}}};TLORM.SystemManager.prototype.updateAllSystems=function(a){for(var b=0;b<this.systems.length;++b){if(this.systems[b].type!="Render"){this.systems[b].update(a)}}};TLORM.SystemManager.prototype.renderAllSystems=function(a){this.systems_by_type.Render.update(a)};TLORM.ResourceManager=function(){this.images={};this.files={};this.json={};this.audio={};this.to_load=0;this.num_items=0;this.no_cache=true};TLORM.ResourceManager.prototype.addImage=function(c){if(this.images[c]){return this.images[c].img}var b=new Image();++this.to_load;++this.num_items;var a=this;b.onload=function(){--a.to_load;a.images[c].loaded=true};if(this.no_cache){b.src=c+"?"+new Date().getTime()}else{b.src=c}this.images[c]={img:b,loaded:false};return b};TLORM.ResourceManager.prototype.getImage=function(a){return this.images[a].img};TLORM.ResourceManager.prototype.loadFile=function(c){if(this.files[c]){return this.files[c].contents}++this.to_load;++this.num_items;this.files[c]={contents:null,loaded:false};var b=this;var a=new XMLHttpRequest();a.onreadystatechange=function(){if(a.readyState===4){--b.to_load;b.files[c].contents=a.responseText;b.files[c].loaded=true}};if(this.no_cache){a.open("GET",c+"?"+new Date().getTime(),false)}else{a.open("GET",c,false)}a.send();return this.files[c].contents};TLORM.ResourceManager.prototype.getFile=function(a){return this.files[a].contents};TLORM.ResourceManager.prototype.loadJSON=function(src){if(this.json[src]){return this.json[src].contents}++this.to_load;++this.num_items;this.json[src]={contents:null,loaded:false};var rm=this;var ajax=new XMLHttpRequest();ajax.onreadystatechange=function(){if(ajax.readyState===4){--rm.to_load;rm.json[src].contents=eval("("+ajax.responseText+")");rm.json[src].loaded=true}};if(this.no_cache){ajax.open("GET",src+"?"+new Date().getTime(),false)}else{ajax.open("GET",src,false)}ajax.send();return this.json[src].contents};TLORM.ResourceManager.prototype.getJSON=function(a){return this.json[a].contents};TLORM.ResourceManager.prototype.addAudio=function(b){if(this.audio[b]){return this.audio[b].audio}var a=new Audio(b);++this.num_items;if(this.no_cache){a.src=b+"?"+new Date().getTime()}else{a.src=b}this.audio[b]={audio:a,loaded:false};return a};TLORM.ResourceManager.prototype.getAudio=function(a){return this.audio[a].audio};TLORM.ResourceManager.prototype.allLoaded=function(a){return this.to_load===0};TLORM.ResourceManager.prototype.percentageLoaded=function(a){var b=this.num_items-this.to_load;return(b/this.num_items)*100};TLORM.GameMenu=function(b,a){this.game=b;this.context=this.game.canvasContext();this.menus_def=b.resource_manager.loadJSON(a);this.w=this.menus_def.w;this.h=this.menus_def.h;this.start_game=this.menus_def.game;this.menus={};for(var c in this.menus_def.menus){var d=this.menus_def.menus[c];this.menus[c]=d}this.option_position={x:30,y:this.h/2,w:this.w-60,h:30,dh:20,label_x:this.w/2,label_dy:23};this.reset()};TLORM.GameMenu.prototype.reset=function(){this.current_menu=this.menus_def.start;this.current_option_args=[];this.game.setSize(this.w,this.h);var a=this;this.game.unregisterAllEvents();this.game.registerEvent("click",function(b){a.clickHandler(b)});this.game.registerEvent("touch",function(b){a.clickHandler(b)})};TLORM.GameMenu.prototype.show=function(){if(this.current_menu=="game"){this.game.unregisterAllEvents();var a=this.current_option_args.slice();a.unshift(this.game);this.start_game.apply(this.start_game,a)}else{this.display(this.current_menu);this.game.update()}};TLORM.GameMenu.prototype.display=function(b){var d=this.menus[b];this.context.fillStyle=d.background;this.context.fillRect(0,0,this.w,this.h);this.context.fillStyle="#000";this.context.font="30px Arial";this.context.textAlign="center";this.context.fillText(d.title,this.w/2,30);this.context.font="20px Arial";for(var a=0;a<d.messages.length;++a){var c=60+(30*a);this.context.fillText(d.messages[a],this.w/2,c)}this.context.font="20px Arial";this.context.textAlign="center";this.context.strokeStyle="#000";for(var a=0;a<d.options.length;++a){var c=this.option_position.y+((this.option_position.h+this.option_position.dh)*a);this.context.fillStyle="#ABC";this.context.fillRect(this.option_position.x,c,this.option_position.w,this.option_position.h);this.context.strokeRect(this.option_position.x,c,this.option_position.w,this.option_position.h);this.context.fillStyle="#000";this.context.fillText(d.options[a].title,this.option_position.label_x,c+this.option_position.label_dy)}};TLORM.GameMenu.prototype.clickHandler=function(c){var b=this.menus[this.current_menu].options;if(this.option_position.x<=c.offsetX&&c.offsetX<=this.option_position.x+this.option_position.w&&this.option_position.y<=c.offsetY&&c.offsetY<=this.option_position.y+((this.option_position.h+this.option_position.dh)*b.length)){var a=Math.floor((c.offsetY-this.option_position.y)/(this.option_position.h+this.option_position.dh));if(c.offsetY<=this.option_position.y+((this.option_position.h+this.option_position.dh)*a)+this.option_position.h){this.current_menu=b[a].destination;this.current_option_args=b[a].args;this.show()}}};TLORM.QuickEntity={};TLORM.Entity=function(c,f,a,g,b,e){this.id=null;this.name=c;this.px=a;this.py=g;this.x=a;this.y=g;this.point=new TLORM.Math.Point(a,g);this.w=b;this.h=e;this.bounding_box=new TLORM.Math.Quadrilateral(new TLORM.Math.Point(a,g),new TLORM.Math.Point(a+b,g+e));this.components=[];this.components_by_type={};if(f){for(var d=0;d<f.length;++d){this.addComponent(f[d])}}};TLORM.Entity.prototype.addComponent=function(a){this.components.push(a);this.components_by_type[a.type]=a};TLORM.Entity.prototype.removeComponent=function(a){for(var b=0;b<this.components.length;++b){if(this.components[b]===a){this.components.splice(b,1)}}delete this.components_by_type[a.type]};TLORM.Entity.prototype.getComponentByType=function(a){if(this.components_by_type[a]){return this.components_by_type[a]}return null};TLORM.Entity.prototype.initAllComponents=function(a){for(var b=0;b<this.components.length;++b){if(this.components[b].init){this.components[b].init(a)}}};TLORM.Entity.prototype.initAllComponents=function(a){for(var b=0;b<this.components.length;++b){if(this.components[b].init){this.components[b].init(a)}}};TLORM.Entity.prototype.getRequiredSystems=function(){var b=[];for(var a=0;a<this.components.length;++a){if(this.components[a].system){b.push(this.components[a].system)}}return b};TLORM.Entity.prototype.move=function(b,a){this.moveTo((b==null?null:this.x+b),(a==null?null:this.y+a))};TLORM.Entity.prototype.moveTo=function(a,b){this.px=this.x;this.py=this.y;if(a!=null){this.x=a;this.point.x=a}if(b!=null){this.point.y=a;this.y=b}this.bounding_box=new TLORM.Math.Quadrilateral(new TLORM.Math.Point(this.x,this.y),new TLORM.Math.Point(this.x+this.w,this.y+this.h))};TLORM.Entity.prototype.direction=function(){var b=this.px-this.x;var a=this.py-this.y;if(b==0&&a==0){return""}else{if(b<0){return"R"}else{if(b>0){return"L"}else{if(a<0){return"D"}else{if(a>0){return"U"}}}}}};TLORM.System={};TLORM.Utility={arrayToLookupHash:function(c){var b={};for(var a=0;a<c.length;++a){b[c[a]]=true}return b}};TLORM.Game=function(b,a){this.name=b;this.canvas=a;this.context=this.canvas.getContext("2d");this.running=false;this.loop_time=33;this.stop_message="GAME OVER!";this.default_systems=["Animation","Transformation","Collision","Movement"];this.onStop=null;this.events={};this.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;this.working_canvas=document.createElement("canvas");this.working_context=this.working_canvas.getContext("2d");this.entity_manager=new TLORM.EntityManager();this.resource_manager=new TLORM.ResourceManager();this.system_manager=new TLORM.SystemManager();this.parseParams()};TLORM.Game.prototype.parseParams=function(){this.params={};if(location.search){var c=location.search.substring(1).split("&");for(var a=0;a<c.length;a++){var b=c[a].split("=");if(b[0]){this.params[b[0]]=b[1]}}}};TLORM.Game.prototype.param=function(a){return this.params[a]};TLORM.Game.prototype.progressBar=function(){if(this.progress_bar){return this.progress_bar}this.progress_bar=document.createElement("progress");this.progress_bar.max=100;this.progress_bar.style.position="absolute";this.progress_bar.style.zIndex=1;this.progress_bar.style.top=window.innerHeight/2;this.progress_bar.style.left=window.innerWidth/2-100;document.body.appendChild(this.progress_bar);return this.progress_bar};TLORM.Game.prototype.removeProgressBar=function(){if(this.progress_bar){document.body.removeChild(this.progress_bar)}};TLORM.Game.prototype.reset=function(){this.entity_manager=new TLORM.EntityManager();this.resource_manager=new TLORM.ResourceManager();this.system_manager=new TLORM.SystemManager()};TLORM.Game.prototype.border=function(){return 10};TLORM.Game.prototype.setSize=function(a,b){this.canvas.width=a;this.canvas.height=b;if(this.buffer_context){this.buffer_canvas.width=a;this.buffer_canvas.height=b}};TLORM.Game.prototype.canvasContext=function(){if(!this.buffer_context){this.buffer_canvas=document.createElement("canvas");this.buffer_canvas.width=this.canvas.width;this.buffer_canvas.height=this.canvas.height;this.buffer_context=this.buffer_canvas.getContext("2d")}return this.buffer_context};TLORM.Game.prototype.registerEvent=function(a,b){if(a.indexOf("key")==-1){this.canvas.addEventListener(a,b)}else{document.addEventListener(a,b)}if(!this.events[a]){this.events[a]=[]}this.events[a].push(b)};TLORM.Game.prototype.unregisterAllEvents=function(b){if(b){if(this.events[b]){for(var a=0;a<this.events[b].length;++a){this.canvas.removeEventListener(b,this.events[b][a])}}}else{for(var b in this.events){this.unregisterAllEvents(b)}}};TLORM.Game.prototype.start=function(){this.entity_manager.initAllEntities(this);var b=this.default_systems.concat(this.entity_manager.getRequiredSystems());for(var a=0;a<b.length;++a){if(!this.system_manager.getSystemByType(b[a])){this.system_manager.addSystem(new TLORM.System[b[a]]())}}this.system_manager.addSystem(new TLORM.System.Render(this.canvasContext(),this.working_context,this.canvas.width,this.canvas.height));this.system_manager.initAllSystems(this);this.startIfResourcesLoaded()};TLORM.Game.prototype.startIfResourcesLoaded=function(){var a=this;if(!this.resource_manager.allLoaded(this)){this.progressBar().value=this.resource_manager.percentageLoaded(this);setTimeout(function(){a.startIfResourcesLoaded()},1)}else{this.progressBar().value=100;setTimeout(function(){a.removeProgressBar();a.running=true;a.updateLoop();a.renderLoop()},100)}};TLORM.Game.prototype.stop=function(b){this.running=false;var a=this;setTimeout(function(){if(b){var c=alert(a.stop_message)}if(a.onStop){a.onStop()}},this.loop_time)};TLORM.Game.prototype.gameOver=function(b,a){this.stop_message="GAME OVER!\n"+(b?"Congratulations, you won!":"Sorry, you lost!")+(a?" Your score was "+a:"");this.stop()};TLORM.Game.prototype.updateLoop=function(){if(this.running){this.update();var a=this;setTimeout(function(){a.updateLoop()},this.loop_time)}};TLORM.Game.prototype.update=function(){this.entity_manager.update(this);this.system_manager.updateAllSystems(this)};TLORM.Game.prototype.renderLoop=function(){if(this.running){this.render();var a=this;this.requestAnimationFrame.call(window,function(){a.renderLoop()})}};TLORM.Game.prototype.render=function(a){this.system_manager.renderAllSystems(this);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.drawImage(this.buffer_canvas,0,0)};TLORM.NTree=function(j,b,i,c,f,g,e,a){this.n=j;this.x=b;this.y=i;this.w=c;this.h=f;this.d=g;this.max_entities_per_branch=e;this.max_depth=a;this.entites=[];this.branches=null;if(this.n%2!=0){throw"Currently can only handle a NTree where N is divisble by 2"}};TLORM.NTree.prototype.clear=function(){this.entites=[];if(this.branches){for(var a=0;a<this.n;++a){this.branches[a].clear()}this.branches=null}};TLORM.NTree.prototype.split=function(){var a=Math.round(this.w/(this.n/2));var a=Math.round(this.w/(this.n/2))};TLORM.EntityManager=function(){this.next_id=1;this.entities=[];this.entities_by_type={};this.entities_by_id={};this.to_remove=[];this.to_add=[]};TLORM.EntityManager.prototype.addEntity=function(a){this._addEntity(a);return a};TLORM.EntityManager.prototype._addEntity=function(a){a.id=this.next_id++;this.entities.push(a);for(var b=0;b<a.components.length;++b){if(!this.entities_by_type[a.components[b].type]){this.entities_by_type[a.components[b].type]=[]}this.entities_by_type[a.components[b].type].push(a)}this.entities_by_id[a.id]=a;return a};TLORM.EntityManager.prototype.removeEntity=function(a){this.to_remove.push(a)};TLORM.EntityManager.prototype._removeEntity=function(a){for(var d=0;d<this.entities.length;++d){if(this.entities[d]===a){this.entities.splice(d,1);break}}for(d=0;d<a.components.length;++d){var c=a.components[d];if(this.entities_by_type[c.type]){for(var b=0;b<this.entities_by_type[c.type].length;++b){if(this.entities_by_type[c.type][b]===a){this.entities_by_type[c.type].splice(b,1);break}}}}if(this.entities_by_id[a.id]){delete this.entities_by_id[a.id]}};TLORM.EntityManager.prototype.getEntities=function(){return this.entities};TLORM.EntityManager.prototype.getEntitiesByType=function(a){if(this.entities_by_type[a]){return this.entities_by_type[a]}return[]};TLORM.EntityManager.prototype.getEntitiesByPosition=function(a,d){var c=[];for(var b=0;b<this.entities.length;b++){if(this.entities[b].x===a&&this.entities[b].y===d){c.push(this.entities[b])}}return c};TLORM.EntityManager.prototype.addEntityComponent=function(a,b){if(this.entities_by_id[a.id]){a.addComponent(b);if(!this.entities_by_type[b.type]){this.entities_by_type[b.type]=[]}this.entities_by_type[b.type].push(a)}};TLORM.EntityManager.prototype.removeEntityComponent=function(a,b){if(this.entities_by_id[a.id]){a.removeComponent(b);for(var c=0;c<this.entities_by_type[b.type].length;++c){if(this.entities_by_type[b.type][c]===a){this.entities_by_type[b.type].splice(c,1);break}}}};TLORM.EntityManager.prototype.initAllEntities=function(a){for(var b=0;b<this.entities.length;++b){this.entities[b].initAllComponents(a)}};TLORM.EntityManager.prototype.getRequiredSystems=function(){var b=[];for(var a=0;a<this.entities.length;++a){b=b.concat(this.entities[a].getRequiredSystems())}return b};TLORM.EntityManager.prototype.update=function(a){for(var b=0;b<this.to_remove.length;++b){this._removeEntity(this.to_remove[b])}this.to_remove=[];for(var b=0;b<this.to_add.length;++b){this._addEntity(this.to_add[b])}this.to_add=[]};TLORM.QuickEntity.Box=function(n,a,l,k,j,m,e,i,b,c,g){var f=[TLORM.Component.Position(l,k,j,m,e,i),TLORM.Component.Render(1,b),];if(c){f.push(TLORM.Component.Texture(c,0,0,m,e))}if(g){f.push(TLORM.Component.Collidable("box"))}return n.entity_manager.addEntity(new TLORM.Entity(a,f))};TLORM.QuickEntity.Camera=function(i,a,g,f,e,c,b,k,j,h){var d=[TLORM.Component.Position(g,f,e,1,1,1),TLORM.Component.Camera(c)];if(b){d.push(TLORM.Component.Follow(b,k,j,h))}return i.entity_manager.addEntity(new TLORM.Entity(a,d))};TLORM.QuickEntity.Player=function(m,a,k,j,i,l,e,g,c,b){var f=[TLORM.Component.Position(k,j,i,l,e,g),TLORM.Component.Render(2,c),TLORM.Component.Collidable("player"),TLORM.Component.CollisionDetection("box",b),];return m.entity_manager.addEntity(new TLORM.Entity(a,f))};TLORM.QuickEntity.Grid=function(l,c,e,d,j,n,b,a,g,m,f){for(var k=e;k<=d;k+=j){for(var i=n;i<=b;i+=a){for(var h=g;h<=m;h+=f){l.entity_manager.addEntity(new TLORM.Entity(c,[TLORM.Component.Position(k,i,h,1,1,1),TLORM.Component.Render(1,"rgba(0,0,0,0.5)","rgba(0,0,0,0.95)"),]))}}}};TLORM.QuickEntity.BuildingFloor=function(s,v,g,f,e,j,o,r,c,m,b,q,l,a,k,t){var u=TLORM.Component.GenerateDungeon(j,r,m,b,q,l,3);for(var n=0;n<u.rooms.length;++n){var p=u.rooms[n];TLORM.QuickEntity.Box(s,v+"_room_"+n,g+p.x,f,e+p.y,p.w,o,p.h,a,t,true)}return TLORM.QuickEntity.Box(s,v,g,f,e,j,2,r,c,k)};TLORM.QuickEntity.Building=function(n,b,k,j,g,m,e,f,c,l,a){var i=TLORM.QuickEntity.Box(n,b,k,j,g,m,e,f,c);return i};TLORM.QuickEntity.Terrain=function(l,a,j,i,g,k,c,f,b,e){return l.entity_manager.addEntity(new TLORM.Entity(a,[TLORM.Component.Position(j,i,g,k,c,f),TLORM.Component.Render(1,b),TLORM.Component.Terrain(e),]))};TLORM.System.Render=function(b,d,a,c){return{type:"Render",context:b,working_context:d,w:a,h:c,update:function(g){var m=g.entity_manager.getEntitiesByType("Camera")[0];this.context.clearRect(0,0,this.w,this.h);var f=this.getRenderableEntities(g,m);for(var l=0;l<f.length;++l){if(f[l]){for(var h=f[l].max_index;h>=f[l].min_index;--h){if(f[l].items[h]){for(var e in f[l].items[h]){this.renderEntity(g,f[l].items[h][e],m)}}}}}},getRenderableEntities:function(q,m){var h=(m?m.getComponentByType("Position"):null);var n=(h?h.point.z:null);var o=(h?h.point.y:null);var l=q.entity_manager.getEntitiesByType("Render");var f=[];for(var j=0;j<l.length;++j){var g=l[j];var e=g.getComponentByType("Render");var k=g.getComponentByType("Position");var p=k.point.z+k.d;var r=k.point.y+k.d;if(e&&k&&((!n&&!o)||(TLORM.Component.CameraType=="H"&&p>n)||(TLORM.Component.CameraType=="V"&&r>o))){if(!n&&!o){if(!f[e.z]){f[e.z]={min_index:0,max_index:0,items:[[]]}}f[e.z].items[0].push(g)}else{if(!f[e.z]){f[e.z]={min_index:0,max_index:0,items:[]}}if(TLORM.Component.CameraType=="H"){if(!f[e.z].items[p]){f[e.z].items[p]=[]}f[e.z].items[p].push(g);if(p<f[e.z].min_index){f[e.z].min_index=p}if(p>f[e.z].max_index){f[e.z].max_index=p}}else{if(TLORM.Component.CameraType=="V"){if(!f[e.z].items[r]){f[e.z].items[r]=[]}f[e.z].items[r].push(g);if(r<f[e.z].min_index){f[e.z].min_index=r}if(r>f[e.z].max_index){f[e.z].max_index=r}}}}}}return f},renderEntity:function(p,k,n){var e=k.getComponentByType("Render");if(n){var f=this.getFaces(n,k);var o=k.getComponentByType("Texture");var g=k.getComponentByType("Image");if(g){this.context.fillStyle=this.context.createPattern(g.img,"no-repeat")}else{if(o){this.context.fillStyle=this.context.createPattern(o.img,"repeat");if(false){this.working_context.save();this.working_context.fillStyle=this.working_context.createPattern(o.img,"repeat");this.working_context.fill();this.working_context.restore()}}else{if(e.fill_colour){this.context.fillStyle=e.fill_colour}if(e.stroke_colour){this.context.stokeStyle=e.stroke_colour}}}for(var l=0;l<f.length;++l){this.context.beginPath();this.context.moveTo(f[l][0].x,f[l][0].y);for(var h=1;h<f[l].length;++h){this.context.lineTo(f[l][h].x,f[l][h].y)}this.context.lineTo(f[l][0].x,f[l][0].y);this.context.closePath();if(e.stroke_colour){this.context.stroke()}if(g||o||e.fill_colour){this.context.fill()}this.context.closePath()}}else{var m=k.getComponentByType("Position");if(e.fill_colour){this.context.fillStyle=e.fill_colour;this.context.fillRect(m.point.x,m.point.y,m.w,m.h)}if(e.stroke_colour){this.context.stokeStyle=e.stroke_colour;this.context.strokeRect(m.point.x,m.point.y,m.w,m.h)}}},getFaces:function(h,g){var i=h.getComponentByType("Position");var f=g.getComponentByType("Position");var k=f.point.z;var l=f.point.y;var j=f.d;if(TLORM.Component.CameraType=="H"&&f.point.z<=i.point.z){f.d-=i.point.z-f.point.z-1;f.point.z=i.point.z+1}else{if(TLORM.Component.CameraType=="V"&&f.point.y<=i.point.y){f.d-=i.point.y-f.point.y-1;f.point.y=i.point.y+1}}var e=[[TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y,f.point.z),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y,f.point.z),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y+f.h,f.point.z),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y+f.h,f.point.z),h,this.w,this.h)],[TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y,f.point.z),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y,f.point.z+f.d),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y+f.h,f.point.z+f.d),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y+f.h,f.point.z),h,this.w,this.h)],[TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y,f.point.z+f.d),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y,f.point.z+f.d),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y+f.h,f.point.z+f.d),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x+f.w,f.point.y+f.h,f.point.z+f.d),h,this.w,this.h)],[TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y,f.point.z),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y,f.point.z+f.d),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y+f.h,f.point.z+f.d),h,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(f.point.x,f.point.y+f.h,f.point.z),h,this.w,this.h)],];e=e.concat(this.getTopFaces(h,g));f.point.z=k;f.point.y=l;f.d=j;return e},getTopFaces:function(n,j){var m=j.getComponentByType("Position");var e=j.getComponentByType("Terrain");if(e&&e.height_map.length>2){var g=[];var f=e.height_map;for(var k=0;k<f.length;++k){var h=f[k].nearest(f,2);g.push([TLORM.CameraFunctions.point_on_screen(f[k],n,this.w,this.h),TLORM.CameraFunctions.point_on_screen(h[0],n,this.w,this.h),TLORM.CameraFunctions.point_on_screen(h[1],n,this.w,this.h)])}var l=[new TLORM.Math.Point(m.point.x,m.point.y+m.h,m.point.z),new TLORM.Math.Point(m.point.x,m.point.y+m.h,m.point.z+m.d),new TLORM.Math.Point(m.point.x+m.w,m.point.y+m.h,m.point.z+m.d),new TLORM.Math.Point(m.point.x+m.w,m.point.y+m.h,m.point.z),];for(var k=0;k<l.length;++k){var h=l[k].nearest(f,1);g.push([TLORM.CameraFunctions.point_on_screen(l[(k==0?l.length-1:k-1)],n,this.w,this.h),TLORM.CameraFunctions.point_on_screen(h[0],n,this.w,this.h),TLORM.CameraFunctions.point_on_screen(l[k],n,this.w,this.h)])}return g}else{return[[TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(m.point.x,m.point.y+m.h,m.point.z),n,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(m.point.x,m.point.y+m.h,m.point.z+m.d),n,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(m.point.x+m.w,m.point.y+m.h,m.point.z+m.d),n,this.w,this.h),TLORM.CameraFunctions.point_on_screen(new TLORM.Math.Point(m.point.x+m.w,m.point.y+m.h,m.point.z),n,this.w,this.h)],]}}}};TLORM.System.Gravity=function(a){return{type:"Gravity",g:a||10,init:function(b){},update:function(c){var b=this.getEntitiesWithMass(c)},getEntitiesWithMass:function(b){return b.entity_manager.getEntitiesByType("Mass")},}};TLORM.System.Movement=function(){return{type:"Movement",moveEvent:null,init:function(a){var b=this;a.registerEvent("mousemove",function(c){b.moveHandler(c)});a.registerEvent("mouseout",function(c){b.moveHandler(c)})},moveHandler:function(a){this.moveEvent=a},outHandler:function(a){this.moveEvent=null},update:function(m){var j=this.getFollowers(m);for(var g=0;g<j.length;++g){var h=j[g];var c=h.getComponentByType("Follow");var l=h.getComponentByType("Position");var a=c.follow;var e=a.getComponentByType("Position");if(l&&e){l.point.x=e.point.x+c.dx;l.point.y=e.point.y+c.dy;l.point.z=e.point.z+c.dz}}if(this.moveEvent){var f=this.getMouseMoveable(m)[0];if(f){var b=f.getComponentByType("FollowMouse");var d=this.moveEvent.offsetX-f.x-f.w/2;if(Math.abs(d)<=b.speed){f.moveTo(this.moveEvent.offsetX-f.w/2,null)}else{if(d<0){f.move(-b.speed,null)}else{f.move(b.speed,null)}}var k=this.moveEvent.offsetY-f.y-f.h/2;if(Math.abs(k)<=b.speed){f.moveTo(null,this.moveEvent.offsetY-f.h/2)}else{if(k<0){f.move(null,-b.speed)}else{f.move(null,b.speed)}}}}},getMouseMoveable:function(a){return a.entity_manager.getEntitiesByType("FollowMouse")},getFollowers:function(a){return a.entity_manager.getEntitiesByType("Follow")},}};TLORM.System.Transformation=function(a){return{type:"Transformation",update:function(c){var f=this.getTransforms(c);for(var e=0;e<f.length;++e){var b=f[e];var d=b.getComponentByType("Transform");if(d.dx!=null){b.x+=d.dx}if(d.dy!=null){b.y+=d.dy}if(d.x!=null){b.x=d.x}if(d.y!=null){b.y=d.y}if(d.dw!=null){b.w+=d.dw}if(d.dh!=null){b.h+=d.dh}if(d.w!=null){b.w=d.w}if(d.h!=null){b.h=d.h}c.entity_manager.removeEntityComponent(b,d)}},getTransforms:function(b){return b.entity_manager.getEntitiesByType("Transform")}}};TLORM.System.Collision=function(){return{type:"Collision",update:function(a){var f=this.getCollisionDetections(a);var e=this.getCollidables(a);for(var c=0;c<f.length;++c){var d=f[c].getComponentByType("CollisionDetection");for(var b=0;b<e.length;++b){if(f[c]!=e[b]&&this.collides(f[c],e[b])){d.callback.call(d,e[b],f[c].direction())}}}},getCollidables:function(a){return a.entity_manager.getEntitiesByType("Collidable")},getCollisionDetections:function(a){return a.entity_manager.getEntitiesByType("CollisionDetection")},collides:function(d,c){var f=d.getComponentByType("Collidable");var e=c.getComponentByType("Collidable");if(!f&&!e){return false}if(f.ignoreGroup(e.group)||e.ignoreGroup(f.group)){return false}var b=d.getComponentByType("Position");var a=c.getComponentByType("Position");if(b.point.x<=a.point.x+a.w&&a.point.x<=b.point.x+b.w&&b.point.y<=a.point.y+a.h&&a.point.y<=b.point.y+b.h&&b.point.z<=a.point.z+a.d&&a.point.z<=b.point.z+b.d){return true}return false},}};TLORM.System.Debug=function(a){return{type:"Debug",component_types:a,update:function(b){var d=[];if(!this.component_types){d=b.entity_manager.getEntities()}for(var c=0;c<d.length;++c){console.log("Entity: "+d[c].name)}}}};TLORM.System.Animation=function(a){return{type:"Animation",update:function(c){var f=this.getAnimations(c);for(var d=0;d<f.length;++d){var b=f[d];var e=b.getComponentByType("Animation");if(e.step==0){e.on_start(e);++e.step}else{if(e.step>=e.steps){e.on_end(e);c.entity_manager.removeEntityComponent(b,e)}else{e.on_step(e,e.step);++e.step}}}},getAnimations:function(b){return b.entity_manager.getEntitiesByType("Animation")}}};(function(i,j,c,h,l,f,b){j.seedrandom=function g(m,q){var o=[];var n;m=k(a(q?[m,i]:arguments.length?m:[new Date().getTime(),i,window],3),o);n=new e(o);k(n.S,i);j.random=function p(){var t=n.g(h);var s=b;var r=0;while(t<l){t=(t+r)*c;s*=c;r=n.g(1)}while(t>=f){t/=2;s/=2;r>>>=1}return(t+r)/s};return m};function e(r){var q,o,v=this,s=r.length;var p=0,n=v.i=v.j=v.m=0;v.S=[];v.c=[];if(!s){r=[s++]}while(p<c){v.S[p]=p++}for(p=0;p<c;p++){q=v.S[p];n=d(n+q+r[p%s]);o=v.S[n];v.S[p]=o;v.S[n]=q}v.g=function m(C){var A=v.S;var z=d(v.i+1);var y=A[z];var x=d(v.j+y);var w=A[x];A[z]=w;A[x]=y;var B=A[d(y+w)];while(--C){z=d(z+1);y=A[z];x=d(x+y);w=A[x];A[z]=w;A[x]=y;B=B*c+A[d(y+w)]}v.i=z;v.j=x;return B};v.g(c)}function a(p,q,m,r,n){m=[];n=typeof(p);if(q&&n=="object"){for(r in p){if(r.indexOf("S")<5){try{m.push(a(p[r],q-1))}catch(o){}}}}return(m.length?m:p+(n!="string"?"\0":""))}function k(m,o,p,n){m+="";p=0;for(n=0;n<m.length;n++){o[d(n)]=d((p^=o[d(n)]*19)+m.charCodeAt(n))}m="";for(n in o){m+=String.fromCharCode(o[n])}return m}function d(m){return m&(c-1)}b=j.pow(c,h);l=j.pow(2,l);f=l*2;k(j.random(),i)})([],Math,256,6,52);TLORM.Component.Render=function(e,c,d,a,b){return{type:"Render",z:e,highlight_alpha:a,fill_colour:c,other_fill_colour:b,stroke_colour:d,show_name:false}};TLORM.Component.Transform=function(d,c,e,g,a,i,b,f){return{type:"Transform",system:"Transformation",dx:d,dy:c,dw:e,dh:g,x:a,y:i,w:b,h:f}};TLORM.Component.CollisionDetection=function(a,b){return{type:"CollisionDetection",system:"Collision",group:a,callback:b,}};TLORM.Component.CameraType="V";TLORM.Component.Camera=function(a){return{type:"Camera",fov:a,d:1/Math.tan(a/2),setFOV:function(b){this.d=1/Math.tan(b/2);this.fov=b}}};TLORM.CameraFunctions={world_point_to_camera_point:function(c,b){var a=c.getComponentByType("Position");return new TLORM.Math.Point(b.x-a.point.x,b.y-a.point.y,b.z-a.point.z)},camera_point_to_projection_point:function(c,a){var b=c.getComponentByType("Camera");if(TLORM.Component.CameraType=="H"){return new TLORM.Math.Point(a.x*(b.d/a.z),a.y*(b.d/a.z))}else{if(TLORM.Component.CameraType=="V"){return new TLORM.Math.Point(a.x*(b.d/a.y),a.z*(b.d/a.y))}}},projection_point_to_screen_point:function(b,c,e){var a=c/2;var d=e/2;return new TLORM.Math.Point(a+a*b.x,d-d*b.y)},point_on_screen:function(a,d,b,c){var g=TLORM.CameraFunctions.world_point_to_camera_point(d,a);var f=TLORM.CameraFunctions.camera_point_to_projection_point(d,g);var e=TLORM.CameraFunctions.projection_point_to_screen_point(f,b,c);return e},screen_point_to_projection_point:function(b,c,e){var a=c/2;var d=e/2;return new TLORM.Math.Point((b.x-a)/a,(b.y-d)/-d)},projection_point_to_camera_point:function(d,b){var c=d.getComponentByType("Camera");var a=d.getComponentByType("Position").point;if(a.z==null){return null}return new TLORM.Math.Point(b.x/(c.d/a.z),b.y/(c.d/a.z))},camera_point_to_world_point:function(c,b){var a=c.getComponentByType("Position");return new TLORM.Math.Point(b.x+a.point.x,b.y+a.point.y)},screen_point_to_world_point:function(a,d,b,c){var e=TLORM.CameraFunctions.screen_point_to_projection_point(a,b,c);var g=TLORM.CameraFunctions.projection_point_to_camera_point(d,e);var f=TLORM.CameraFunctions.camera_point_to_world_point(d,g);return f},};TLORM.Component.Follow=function(b,d,c,a){return{type:"Follow",follow:b,dx:d||0,dy:c||0,dz:a||0,}};TLORM.Component.Sprite=function(a,f,e,g,c,j,i,b,d){return{type:"Sprite",src:a,x:f,y:e,w:g,h:c,dx:j,dy:i,dw:b,dh:d,img:null,init:function(h){this.img=h.resource_manager.addImage(this.src)}}};TLORM.Component.Collidable=function(b,a){return{type:"Collidable",system:"Collision",group:b,ignore_groups:TLORM.Utility.arrayToLookupHash(a||[]),ignoreGroup:function(c){return(this.ignore_groups[c]?true:false)}}};TLORM.Component.Image=function(d,a,e,b,c){return{type:"Image",src:d,x:a,y:e,w:b,h:c,img:null,init:function(f){this.img=f.resource_manager.addImage(this.src)}}};TLORM.Component.GenerateDungeon=function(b,g,a,c,f,i,e){return{type:"GenerateDungeon",w:b,h:g,min_room_w:a,max_room_w:c,min_room_h:f,max_room_h:i,max_doors:e,rooms:d(b,g,a,c,f,i),corridors:[],};function d(s,B,u,o,D,t){var E=[];var F=o-u;var A=t-D;var v=[];var z=Math.floor(s/o);var k=Math.floor(B/t);for(var r=0;r<z;++r){var m=o;var n=r*m;for(var q=0;q<k;++q){var p=t;var j=q*p;v.push({x:n,y:j,w:m,h:p})}}v.sort(function(){return Math.random()-0.5});while(v.length>0){var l=v.pop();var C={x:l.x+Math.floor(Math.random()*u),y:l.y+Math.floor(Math.random()*D),w:u+Math.floor(Math.random()*F),h:D+Math.floor(Math.random()*A),};if(C.x+C.w>l.x+l.w||C.y+C.h>l.y+l.h){v.unshift(l);continue}E.push(C)}return E}};TLORM.Component.Animation=function(b,d,a,c){return{type:"Animation",system:"Animation",on_start:d,on_step:a,on_end:c,step:0,steps:b}};TLORM.Component.Texture=function(a){return{type:"Texture",src:a,img:null,canvas:null,init:function(b){this.img=b.resource_manager.addImage(this.src);this.canvas=document.createElement("canvas")}}};TLORM.Component.Position=function(a,g,f,b,c,e){return{type:"Position",point:new TLORM.Math.Point(a,g,f),w:b,h:c,d:e}};TLORM.Component.Render3D=function(e,c,d,a,b){return{type:"Render3D",z:e,highlight_alpha:a,fill_colour:c,other_fill_colour:b,stroke_colour:d,show_name:false}};TLORM.Component.Terrain=function(a){return{type:"Terrain",height_map:a}};TLORM.Component.FollowMouse=function(a){return{type:"FollowMouse",system:"Movement",speed:a,}};