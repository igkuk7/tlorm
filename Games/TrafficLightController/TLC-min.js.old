TLORM.Component.CityKey={Empty:"E",Road:"R",Building:"B",Grass:"G"};TLORM.Component.City=function(b,a){return{type:"City",map:b,w:a}};TLORM.QuickEntity.BlockThreshold=11;TLORM.QuickEntity.RandomCity=function(i,f,e,g,c,k,d,l,j,b){console.log("Seeding "+b);Math.seedrandom(b);var a=TLORM.QuickEntity.EmptyMap(g,c);TLORM.QuickEntity.AddRingRoad(a);TLORM.QuickEntity.AddRoadGrid(a,l,j);return TLORM.QuickEntity.City(i,"RandomCity",f,e,g*k,c*d,a)};TLORM.QuickEntity.AddRoadGrid=function(g,c,b){var a=g[0].length;var f=g.length;for(var e=0;e<a;++e){for(var d=0;d<f;++d){if((e%c)===0||(d%b)==0){g[d][e]=TLORM.Component.CityKey.Road}}}};TLORM.QuickEntity.GenerateRoadMap=function(c,l,f){var o=Math.min(l,f)/10;var d=[];for(var e=0;e<o;++e){var g={x:Math.floor(Math.random()*l),y:Math.floor(Math.random()*f)};var p=1+Math.round(Math.random()*3);while(p-->0){d.push(g)}}d.sort(function(){return 0.5-Math.random()});while(d.length>1){var k=d.pop();var j=null;var m=10;while(m-->0){j=d.pop();if(k===j){d.unshift(j);j=null}else{break}}if(m==0||!j){console.log("Fatal error")}else{var n=TLORM.QuickEntity.RandomBuilding.ShortestPath(c,k.x,k.y,j.x,j.y);for(var e=0;e<n.length;++e){c[n[e].y][n[e].x]=TLORM.Component.CityKey.Road}}}};TLORM.QuickEntity.EmptyMap=function(a,d){var e=[];for(var c=0;c<d;++c){var f=[];for(var b=0;b<a;++b){f.push(TLORM.Component.CityKey.Empty)}e.push(f)}return e};TLORM.QuickEntity.AddRingRoad=function(d){var a=d[0].length;var c=d.length;for(var b=0;b<a;++b){d[0][b]=TLORM.Component.CityKey.Road;d[c-1][b]=TLORM.Component.CityKey.Road}for(var b=1;b<c-1;++b){d[b][0]=TLORM.Component.CityKey.Road;d[b][a-1]=TLORM.Component.CityKey.Road}};TLORM.QuickEntity.SubdivideCity=function(a,c,h,b,g){var l=b-c;var j=g-h;var k=Math.min(l,j);if(k>TLORM.QuickEntity.BlockThreshold){var f=c+Math.round(l/2);var e=h+Math.round(j/2);for(var d=c;d<=b;++d){a[e][d]=TLORM.Component.CityKey.Road}for(var d=h;d<=g;++d){a[d][f]=TLORM.Component.CityKey.Road}TLORM.QuickEntity.SubdivideCity(a,c,h,f-1,e-1);TLORM.QuickEntity.SubdivideCity(a,f+1,h,b,e-1);TLORM.QuickEntity.SubdivideCity(a,c,e+1,f-1,g);TLORM.QuickEntity.SubdivideCity(a,f+1,e+1,b,g)}else{TLORM.QuickEntity.SubdivideBlock(a,c,h,b,g)}};TLORM.QuickEntity.SubdivideBlock=function(a,d,k,c,g){var m=c-d;var l=g-k;var b=Math.round(0.49+Math.random());var h=[];for(var f=0;f<b;++f){h.push({x:1+d+Math.round(Math.random()*(m-2)),y:1+k+Math.round(Math.random()*(l-2))})}for(var f=0;f<h.length;++f){for(var e=d;e<=c;++e){a[h[f].y][e]=TLORM.Component.CityKey.Road}for(var e=k;e<=g;++e){a[e][h[f].x]=TLORM.Component.CityKey.Road}}};TLORM.QuickEntity.RandomBuildings=function(c,b){for(var a=0;a<b;++a){TLORM.QuickEntity.RandomBuilding(c)}};TLORM.QuickEntity.RandomBuilding=function(a){var k=a[0].length-2;var d=a.length-2;var f=1+Math.floor(Math.random()*k);var e=1+Math.floor(Math.random()*d);a[e][f]=TLORM.Component.CityKey.Building;var l=[{x:f,y:e}];while(l.length>0){var g=l.pop();if(Math.random()<0.5){for(var c=g.x-1;c<g.x+1;++c){if(c<=1||k<=c){continue}for(var b=g.y-1;b<g.y+1;++b){if(b<=1||d<=b){continue}if(a[b]&&a[b][c]&&a[b][c]==TLORM.Component.CityKey.Empty){a[b][c]=TLORM.Component.CityKey.Building;l.push({x:c,y:b})}}}}}};TLORM.QuickEntity.RandomBuilding.ShortestPath=function(b,d,o,c,m){var l=[];var e={};var j=[];var n={};var k={x:d,y:o,F:0,G:0,H:0,parent:null};l.push(k);e[k.x+","+k.y]=k;var f=false;while(l.length>0){l.sort(function(s,i){return(i.F||0)-(s.F||0)});k=l.pop();j.push(k);n[k.x+","+k.y]=k;if(k.x===c&&k.y===m){f=true;break}var r=TLORM.QuickEntity.RandomBuilding.AdjacentCells(b,k.x,k.y);for(var g=0;g<r.length;g++){var p=r[g];if(!n[p.x+","+p.y]){var a=(k.x!=p.x&&k.y!=p.y?14:10);if(p.x===c&&p.y===m){a=0}if(!e[p.x+","+p.y]){p.parent=k;p.G=a+k.G;p.H=(Math.abs(c-p.x)+Math.abs(m-p.y))*10;p.F=p.G+p.H;l.push(p);e[p.x+","+p.y]=p}else{p=e[p.x+","+p.y];var q=a+k.G;if(q<p.G){p.G=q;p.H=(Math.abs(p.x-d)+Math.abs(p.y-o))*10;p.F=p.G+p.H;p.parent=k}}}}}if(f){var h=[];k={x:c,y:m};while(k.x!=d||k.y!=o){h.unshift(k);k=n[k.x+","+k.y].parent}return h}return[]};TLORM.QuickEntity.RandomBuilding.AdjacentCells=function(a,g,f){var j=a[0].length;var d=a.length;var k=[{x:g-1,y:f},{x:g,y:f-1},{x:g+1,y:f},{x:g,y:f+1}];var b=[];for(var c=0;c<k.length;++c){if(k[c].x<0||j<=k[c].x||k[c].y<0||d<=k[c].y){continue}var e=true;if(e){b.push(k[c])}}return b};TLORM.QuickEntity.City=function(c,d,a,i,b,e,g,f){return c.entity_manager.addEntity(new TLORM.Entity(d,[TLORM.Component.Render(1),TLORM.Component.City(g,f)],a,i,b,e))};TLORM.System.Render=function(b,a,c){return{type:"Render",context:b,w:a,h:c,update:function(d){this.context.clearRect(0,0,this.w,this.h);var f=this.getCities(d);for(var e=0;e<f.length;++e){this.renderCity(d,f[e])}},getCities:function(d){return d.entity_manager.getEntitiesByType("City")},renderCity:function(m,g){this.context.fillStyle="#000";this.context.fillRect(g.x,g.y,g.w,g.h);var d=g.getComponentByType("City");var n=g.w/d.map[0].length;var h=g.h/d.map.length;for(var f=0;f<d.map.length;++f){for(var e=0;e<d.map[f].length;++e){var l=e*n;var k=f*h;switch(d.map[f][e]){case TLORM.Component.CityKey.Building:this.context.fillStyle="#AAA";break;case TLORM.Component.CityKey.Road:this.context.fillStyle="#CCC";break;case TLORM.Component.CityKey.Grass:this.context.fillStyle="#AFA";break;case TLORM.Component.CityKey.Empty:default:this.context.fillStyle="#000";break}this.context.fillRect(l,k,n,h)}}}}};var game;window.onload=function(){start_game()};function start_game(a){var b=document.getElementById("tlorm_game_canvas");if(game){game.stop()}game=new TLORM.Game("TLC",b);a=a||game.param("seed")||1;var c=TLORM.QuickEntity.RandomCity(game,0,0,50,50,10,10,4,4,a);game.setSize(c.w,c.h);game.system_manager.addSystem(new TLORM.System.Render(game.canvasContext(),b.width,b.height));game.start()};